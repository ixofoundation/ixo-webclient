import React, { useEffect, useState } from 'react'
import Axios from 'axios'
import LocationMap from 'components/JsonForm/CustomWidgets/LocationSelector/LocationMap/LocationMap'
import { GeoLocation } from 'components/JsonForm/CustomWidgets/LocationSelector/LocationMap/types'

interface Props {
  value: string
  onChange: (value: string) => void
}

const LocationSelector: React.FunctionComponent<Props> = ({ value, onChange }) => {
  const [location, setLocation] = useState<GeoLocation | null>(null)
  useEffect(() => {
    if (value) {
      return
    }

    Axios.get('https://geolocation-db.com/json/afa4d000-8eb9-11eb-a6ff-2538b793e762').then((response) => {
      setLocation({
        lat: response.data.latitude,
        lng: response.data.longitude,
      } as any)
    })
    // eslint-disable-next-line
  }, [])

  if (value) {
    const { lat, lng }: GeoLocation = JSON.parse(value)
    return (
      <LocationMap
        lat={lat}
        lng={lng}
        zoom={15}
        height={300}
        onLocationChange={(geoLocation): void => onChange(JSON.stringify(geoLocation))}
      />
    )
  }

  if (location) {
    const { lat, lng }: GeoLocation = location
    return (
      <LocationMap
        lat={lat}
        lng={lng}
        zoom={15}
        height={300}
        onLocationChange={(geoLocation): void => onChange(JSON.stringify(geoLocation))}
      />
    )
  }

  return null
}

export default LocationSelector
